{"Name":"Dynamic Folder Export","Objects":[{"Type":"DynamicFolder","Name":"System Center Virtual Machine Manager","ScriptInterpreter":"powershell","DynamicCredentialScriptInterpreter":"json","Script":"$VMMServer = 'vmmserver.contoso.com'\n$VMMCredentialPath = \"$env:USERPROFILE\\VMM.cred.xml\"\n\n$RDPCredentialName = 'CONTOSO\\adminuser'\n$SSHCredentialName = 'MySSHUser'\n\nfunction Get-ServerFromSCVMM {\n    <#\n       .SYNOPSIS\n       Get-ServerFromSCVMM is a command to retrieve server information from System Center Virtual Machine Manager.\n       .DESCRIPTION\n       Get-ServerFromSCVMM is a command to retrieve server information from System Center Virtual Machine Manager.\n\n            Required version: Windows PowerShell 3.0 or later \n            Required modules: VirtualMachineManager\n            Required privileges: Read-permission in SC VMM\n\n       .EXAMPLE\n       Get-ServerFromSCVMM -VMMServer SRV01 -Credential (Get-Credential)\n       .EXAMPLE\n       Export data to Excel (requires the ImportExcel module)\n       $XlsxPath = 'C:\\temp\\Servers_VMM_InventoryReport.xlsx'\n       Get-ServerFromSCVMM -VMMServer SRV01 -Credential (Get-Credential) | \n       Export-Excel -Path $XlsxPath -WorkSheetname Servers -AutoSize -TableName Servers -TableStyle Light1\n   #>\n   [CmdletBinding()]\n    Param(\n        [PSCredential]$Credential = (Get-Credential),\n        [string]$VMMServer = 'SRV01'\n    )\n\n\n    $VMMData = @()\n\n    try {\n\n        Write-Verbose \"Connecting to VMM Server $VMMServer\"\n\n        $VMMPSSession = New-PSSession -ComputerName $VMMServer -Credential $Credential -Authentication Negotiate -ErrorAction Stop\n\n        Write-Verbose \"Getting VM hosts\"\n\n        $VMHosts = Invoke-Command -Session $VMMPSSession -ScriptBlock {\n\n            $null = Get-SCVMMServer -ComputerName $using:VMMServer\n            Get-SCVMHost | Select-Object @{n='Name';e={$_.ComputerName}}, @{n='IsVirtualMachine';e={$false}}, LogicalCPUCount, PhysicalCPUCount, @{Name = \"MemoryInGB\"; Expression = {\"{0:N2}\" -f ($_.TotalMemory / 1gb)}}, @{Name = \"TotalStorageCapacityInGB\"; Expression = {\"{0:N2}\" -f ($_.LocalStorageTotalCapacity / 1gb)}}, Operatingsystem\n        \n\n        } -ErrorAction Stop | Select-Object Name,IsVirtualMachine,LogicalCPUCount,PhysicalCPUCount,MemoryInGB,TotalStorageCapacityInGB,OperatingSystem,Description\n\n        $VMMData += $VMHosts\n\n        Write-Verbose \"Found $($VMHosts.Count) VM hosts in VMM\"\n\n        Write-Verbose  \"Getting VMs\"\n\n        $VMs = Invoke-Command -Session $VMMPSSession -ScriptBlock {\n\n            Get-SCVirtualMachine | \n                Where-Object ReplicationMode -ne 'Recovery' | \n                Where-Object {$PSItem.OperatingSystem.Name -notlike \"*Windows XP*\" -and $PSItem.OperatingSystem.Name -notlike \"*Windows 7*\" -and $PSItem.OperatingSystem.Name -notlike \"*Windows 10*\" -and $PSItem.OperatingSystem.Name -ne 'Unknown'} | \n                Select-Object Name, @{n='IsVirtualMachine';e={$true}}, @{n = 'LogicalCPUCount'; e = {$PSItem.CPUCount}}, PhysicalCPUCount, @{Name = \"MemoryInGB\"; Expression = {\"{0:N2}\" -f ($_.Memory / 1kb)}}, @{Name = \"TotalStorageCapacityInGB\"; Expression = {\"{0:N2}\" -f ($_.TotalSize / 1gb)}}, Operatingsystem,Description\n      \n\n        } -ErrorAction Stop | Select-Object Name,IsVirtualMachine,LogicalCPUCount,PhysicalCPUCount,MemoryInGB,TotalStorageCapacityInGB,OperatingSystem,Description\n\n        $VMMData += $VMs\n\n        Write-Verbose \"Found $($VMs.Count) VMs in VMM\" \n\n    }\n\n    catch {\n\n        Write-Error \"An error occured during VMM operations: $($_.Exception.Message)\"\n\n    }    \n\n    if ($VMMPSSession) {\n\n        $VMMPSSession | Remove-PSSession\n\n    }\n\n    $VMMData\n\n} #endfunction\n\n\nif (Test-Path -Path $VMMCredentialPath) {\n\n    $VMMCredential = Import-Clixml -Path $VMMCredentialPath\n\n} else {\n\n    $VMMCredential = Get-Credential -Message 'Specify VMM credentials'\n    $VMMCredential | Export-Clixml -Path $VMMCredentialPath\n\n}\n\n[System.Collections.ArrayList]$Servers = @()\n\nGet-ServerFromSCVMM -VMMServer $VMMServer -Credential $VMMCredential | Sort-Object -Property Name | ForEach-Object {\n    \n    $Server = $PSItem\n\n    if ($Server.Description) {\n\n        $Description = ($Server.OperatingSystem.Name + ' (' + $Server.Description + ')')\n\n    } else {\n\n        $Description = $Server.OperatingSystem\n\n    }\n\n    switch -Wildcard ($PSItem.OperatingSystem)\n    {\n        \"*Linux*\" {\n        \n            $null = $Servers.Add([PSCustomObject]@{\n            Name = $Server.Name\n            Type = 'TerminalConnection'\n            TerminalConnectionType = 'SSH'\n            ComputerName = $Server.Name\n            CredentialName = $SSHCredentialName\n            Path = 'Linux'\n            Description = $Description\n        })\n        }\n    \n        \"*Windows*\" {\n        \n            $null = $Servers.Add([PSCustomObject]@{\n            Name = $Server.Name\n            Type = 'RemoteDesktopConnection'\n            ComputerName = $Server.Name\n            CredentialName = $RDPCredentialName\n            Path = 'Windows'\n            Description = $Description\n        })\n        \n        }\n    \n        Default {\n        \n            $null = $Servers.Add([PSCustomObject]@{\n            Name = $Server.Name\n            Type = 'RemoteDesktopConnection'\n            ComputerName = $Server.Name\n            Path = 'Other'\n            Description = $Description\n        })\n        \n        }\n    \n    }\n\n} \n\n$RoyalTSObjects = @{}\n$null = $RoyalTSObjects.Add('Objects',$Servers)\n\n\n$RoyalTSObjects | ConvertTo-Json"}]}